#ifndef NETEXP_H
#define NETEXP_H

#include <sys/socket.h>
#include <sys/time.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <netdb.h>
#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <time.h>
#include <pthread.h>
#include <ctype.h>


#define		TCP_SERVER_ADDRESS		"127.0.0.1"
#define 	TCP_SERVER_PORT			8000
#define		TCP_BUF_LENGTH			1000
#define 	CONN_NUM				10

#define		UDP_SERVER_ADDRESS		"127.0.0.1"
#define		UDP_RECV_PORT			8001 
#define		UDP_SEND_PORT			8002 
#define		UDP_BUF_LENGTH			1000

#define		RDT_SERVER_ADDRESS		"127.0.0.1"		//RDTæœåŠ¡å™¨ç«¯IP
#define 	RDT_RECV_PORT			8003			//RDTæ¥å—ç«¯ç«¯å£å·
#define		RDT_SEND_PORT			8004			//RDTå‘é€ç«¯ç«¯å£å·
#define		RDT_BEGIN_SEQ			1				//RDTæ•°æ®åŒ…åˆå§‹åºåˆ—å·ï¼Œï¼ˆå‡è®¾æ•°æ®åŒ…åºåˆ—å·ä¸å¾ªç¯ï¼‰		
#define		RDT_SENDWIN_LEN			10				//å‘é€ç«¯çª—å£å¤§å°

#define		RDT_PKT_LOSS_RATE		10			//ä¸å¯ùÕçÑAVé æ•°æ®ä¼ è¾“å±‚çš„ä¸¢åŒ…ç‡
#define		RDT_TIME_OUT			50000		//æ•°æ®åŒ…è¶…æ—¶æ—¶é™
#define		RDT_HEADER_LEN			(4 + 4)		//RDTå¤´æ ‡é•¿åº¦
#define 	RDT_DATA_LEN			1000		//RDTä¸­æ•°æ®åŸŸé•¿åº¦
#define		RDT_PKT_LEN				( RDT_DATA_LEN + RDT_HEADER_LEN )

//RDTåŒ…ç±»å‹
#define		RDT_CTRL_BEGN			0 //åˆå§‹åŒ…
#define		RDT_CTRL_DATA			1 //æ•°æ®åŒ…
#define 	RDT_CTRL_ACK			2 //ACKåŒ…
#define		RDT_CTRL_END			3 //ç»“æŸåŒ…

//æ»‘åŠ¨çª—å£ä¸­æ•°æ®åŒ…çš„çŠ¶æ€
#define		RDT_PKT_ST_INIT			0	//æœªå‘é€
#define		RDT_PKT_ST_SENT			1	//å·²å‘é€ï¼Œæœªç¡®è®¤
#define		RDT_PKT_ST_ACKED		2	//å·²ç¡®è®¤
#define		RDT_PKT_ST_TMOUT		3	//è¶…æ—¶

/*
	æ»‘åŠ¨çª—å£ä¸­æ•°æ®åŒ…çš„ç»“æ„ä½“
*/
typedef struct _STATE_PKT
{
	struct timeval send_time;
	int pkt_seq;
	int pkt_len;
	int state; //æ ‡è¯†æ•°æ®åŒ…çš„çŠ¶æ€
	char rdt_pkt[RDT_PKT_LEN];
}STATE_PKT;

/*
	æ»‘åŠ¨çª—å£çš„ç»“æ„ä½“
*/
typedef struct _SLD_WIN
{
	int win_len;							//æ»‘åŠ¨çª—å£é•¿åº¦
	int send_left;							//æ»‘åŠùÕçÑAV¨çª—å£çš„å·¦ç«¯
	int send_right;							//æ»‘åŠ¨çª—å£çš„å³ç«¯
	pthread_mutex_t lock; 					//æ»‘åŠ¨çª—å£äº’æ–¥é‡ï¼Œä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è®¿é—®å‘é€çª—å£ä¸­çš„æ•°æ®
	STATE_PKT rdt_pkts[RDT_SENDWIN_LEN]; 	//çª—å£ä¸­çš„æ•°æ®åŒ…
}SLD_WIN;


/*
	RDT packet format: |CTRL|SEQ|...DATA...|
	å°†æ•°æ®å°è£…æˆRDTæ•°æ®åŒ…ï¼Œå¤´éƒ¨åªåŒ…å«æ§åˆ¶åŸŸå’Œåºåˆ—å·åŸŸï¼Œå…¶ä¸­æ§åˆ¶åŸŸç”¨æ¥æ ‡è¯†RDTæ•°æ®åŒ…ç±»å‹,åºåˆ—å·åŸŸæ˜¯æ­¤æ•°æ®åŒ…çš„åºåˆ—å·ã€‚
	è¿”å›RDTæ•°æ®åŒ…é•¿åº¦
*/
int pack_rdt_pkt( char *data_buf, char *rdt_pkt, int data_len, int seq_num, int flag );



/*
	RDT packet format: |CTRL|SEQ|...DATA...|
	
	å°†æ•°æ®åŒ…è§£å°è£…ã€‚
	è¿”å›RDTåŒ…ä¸­çš„æ•°æ®é•¿åº¦
*/
int unpack_rdt_pkt( char *data_buf, char *rdt_pkt, int pkt_len, int *seq_num, int *flag );



/*
	æ¨¡æ‹Ÿä¸å¯é æ•°æ®ä¼ è¾“ï¼Œä»¥ä¸€å®šçš„æ¦‚ç‡ï¼ˆRDT_PKT_LOSS_RATEï¼‰ä¸¢å¼ƒæ•°æ®åŒ…
*/
void udt_sendto( int sock_fd, char *pkt, int pkt_len, int flags, struct sockaddr *recv_addr, iùÕçÑAVnt addr_len );



/*
	æ£€æŸ¥ (time_1 - time_2) æ˜¯å¦è¶…è¿‡è®¾å®šæ—¶é™(RDT_TIME_OUT)ï¼Œ
	å¦‚æœè¶…æ—¶è¿”å›1ï¼Œå¦åˆ™è¿”å›0ã€‚
*/
int time_out( struct timeval time_1, struct timeval time_2 );

#endif

; 	//çª—å£ä¸­çš„æ•°æ®åŒ…
}SLD_WIN;


/*
	RDT packet format: |CTRL|SEQ|...DATA...|
	å°†æ•°æ®å°è£…æˆRDTæ•°æ®åŒ…ï¼Œå¤´éƒ¨åªåŒ…å«æ§åˆ¶åŸŸå’Œåºåˆ—å·åŸŸï¼Œå…¶ä¸­æ§åˆ¶åŸŸç”¨æ¥æ ‡è¯†RDTæ•°æ®åŒ…ç±»å‹,åºåˆ—å·åŸŸæ˜¯æ­¤æ•°æ®åŒ…çš„åºåˆ—å·ã€‚
	è¿”å›RDTæ•°æ®åŒ…é•¿åº¦
*/
int pack_rdt_pkt( char *data_buf, char *rdt_pkt, int data_len, int seq_num, int flag );



/*
	RDT packet format: |CTRL|SEQ|...DATA...|
	
	å°†æ•°æ®åŒ…è§£å°è£…ã€‚
	è¿”å›RDTåŒ…ä¸­çš„æ•°æ®é•¿åº¦
*/
int unpack_rdt_pkt( char *data_buf, char *rdt_pkt, int pkt_len, int *seq_num, int *flag );



/*
	æ¨¡æ‹Ÿä¸å¯é æ•°æ®ä¼ è¾“ï¼Œä»¥ä¸€å®šçš„æ¦‚ç‡ï¼ˆRDT_PKT_LOSS_RATEï¼‰ä¸¢å¼ƒæ•°æ®åŒ…
*/
void udt_sendto( int sock_fd, char *pkt, int pkt_len, int flags, struct sockaddr *recv_addr, iùÕçÑAVnt addr_len );



/*
	æ£€æŸ¥ (time_1 - time_2) æ˜¯å¦è¶…è¿‡è®¾å®šæ—¶é™(RDT_TIME_OUT)ï¼Œ
	å¦‚æœè¶…æ—¶è¿”å›1ï¼Œå¦åˆ™è¿”å›0ã€‚
*/
int time_out( struct timeval time_1, struct timeval time_2 );

#endif

; 	//çª—å£ä¸­çš„æ•°æ®åŒ…
}SLD_WIN;


/*
	RDT packet format: |CTRL|SEQ|...DATA...|
	å°†æ•°æ®å°è£…æˆRDTæ•°æ®åŒ…ï¼Œå¤´éƒ¨åªåŒ…å«æ§åˆ¶åŸŸå’Œåºåˆ—å·åŸŸï¼Œå…¶ä¸­æ§åˆ¶åŸŸç”¨æ¥æ ‡è¯†RDTæ•°æ®åŒ…ç±»å‹,åºåˆ—å·åŸŸæ˜¯æ­¤æ•°æ®åŒ…çš„åºåˆ—å·ã€‚
	è¿”å›RDTæ•°æ®åŒ…é•¿åº¦
*/
int pack_rdt_pkt( char *data_buf, char *rdt_pkt, int data_len, int seq_num, int flag );



/*
	RDT packet format: |CTRL|SEQ|...DATA...|
	
	å°†æ•°æ®åŒ…è§£å°è£…ã€‚
	è¿”å›RDTåŒ…ä¸­çš„æ•°æ®é•¿åº¦
*/
int unpack_rdt_pkt( char *data_buf, char *rdt_pkt, int pkt_len, int *seq_num, int *flag );



/*
	æ¨¡æ‹Ÿä¸å¯é æ•°æ®ä¼ è¾“ï¼Œä»¥ä¸€å®šçš„æ¦‚ç‡ï¼ˆRDT_PKT_LOSS_RATEï¼‰ä¸¢å¼ƒæ•°æ®åŒ…
*/
void udt_sendto( int sock_fd, char *pkt, int pkt_len, int flags, struct sockaddr *recv_addr, iùÕçÑAV